(()=>{"use strict";!function(e){const o="localhost"===e.location.hostname||"127.0.0.1"===e.location.hostname||e.location.hostname.includes("webflow.io"),t=o?"/dev":"",n={SUPABASE_URL:"https://bzjoxjqfpmjhbfijthpp.supabase.co",SUPABASE_ANON_KEY:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6am94anFmcG1qaGJmaWp0aHBwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3NjIyMzksImV4cCI6MjA3MTMzODIzOX0.sL9omeLIgpgqYjTJM6SGQPSvUvm5z-Yr9rOzkOi2mJk",ROUTES:{CUSTOMER_ONBOARDING:`${t}/app/customer/onboarding`,RETAILER_ONBOARDING:`${t}/app/retailer/onboarding`,CUSTOMER_DASHBOARD:`${t}/app/customer/dashboard`,RETAILER_DASHBOARD:`${t}/app/retailer/dashboard`,LOGIN_PAGE:`${t}/app/auth/log-in`}},i={getItem:e=>{const o=`; ${document.cookie}`.split(`; ${e}=`);return 2===o.length?decodeURIComponent(o.pop().split(";").shift()):null},setItem:(e,o)=>{document.cookie=`${e}=${encodeURIComponent(o)}; max-age=604800; path=/; secure; samesite=lax`},removeItem:e=>{document.cookie=`${e}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; secure; samesite=lax`}};class a{constructor(){console.log("🚀 NikoAuthCore constructor called"),this.supabase=null,this.initialized=!1,this.authStateListeners=[],console.log("📋 Initial state set, calling init()"),this.init()}async init(){console.log("🔧 Loading Niko Auth Core v5.0.0 (Professional)"),console.log("🌍 Environment:",o?"DEVELOPMENT":"PRODUCTION"),console.log("📍 Current URL:",e.location.href),console.log("🛤️ Path prefix:",t||"(none)"),console.log("🍪 Document cookies available:",document.cookie?"YES":"NO"),"undefined"==typeof supabase?(console.log("📦 Supabase not found, loading from CDN..."),await this.loadSupabase(),console.log("✅ Supabase loaded successfully")):console.log("✅ Supabase already available"),console.log("⚙️ Initializing Supabase client with professional config..."),this.supabase=supabase.createClient(n.SUPABASE_URL,n.SUPABASE_ANON_KEY,{auth:{storage:i,autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"implicit"}}),console.log("✅ Supabase client created with config:",{storage:"cookieStorage",autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"implicit"}),this.initialized=!0,console.log("🎉 Niko Auth Core v5.0.0 initialized with professional security"),console.log("🔗 Available on window.NikoAuthCore and window.NikoAuth"),console.log("👂 Setting up auth state listener..."),this.setupAuthStateListener(),console.log("🚪 Setting up logout handlers..."),this.setupLogoutHandlers(),console.log("📧 Checking for email confirmation token..."),await this.handleEmailConfirmation(),console.log("🔍 Checking initial auth state..."),await this.checkAuthState(),console.log("✨ Initialization complete!")}loadSupabase(){return new Promise((e,o)=>{const t=document.createElement("script");t.src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2",t.onload=e,t.onerror=o,document.head.appendChild(t)})}async handleEmailConfirmation(){const o=new URLSearchParams(e.location.hash.substring(1)),t=o.get("access_token"),n=o.get("refresh_token");if(t&&n){console.log("📬 Email confirmation tokens found in URL");try{const{data:o,error:i}=await this.supabase.auth.setSession({access_token:t,refresh_token:n});if(i)return void console.error("❌ Error setting session from email confirmation:",i);console.log("✅ Session established from email confirmation"),console.log("👤 User confirmed:",o.user?.email),e.history.replaceState({},document.title,e.location.pathname),this.handleAuthenticatedUser(o.user)}catch(e){console.error("❌ Failed to handle email confirmation:",e)}}else console.log("📭 No email confirmation tokens in URL")}setupAuthStateListener(){this.supabase.auth.onAuthStateChange((e,o)=>{switch(console.log("Auth state change:",e),e){case"SIGNED_IN":console.log("User signed in:",o?.user?.email),this.handleAuthenticatedUser(o.user);break;case"SIGNED_OUT":console.log("User signed out"),this.handleSignedOutUser();break;case"TOKEN_REFRESHED":console.log("Token refreshed automatically");break;case"USER_UPDATED":console.log("User updated")}this.authStateListeners.forEach(t=>{try{t(e,o)}catch(e){console.error("Auth state listener error:",e)}})})}onAuthStateChange(e){return this.authStateListeners.push(e),()=>{const o=this.authStateListeners.indexOf(e);o>-1&&this.authStateListeners.splice(o,1)}}handleAuthenticatedUser(o){if(!o)return;const t=o.user_metadata?.user_type||o.user_metadata?.role||"customer",n=o.user_metadata?.name||o.email?.split("@")[0]||"User";document.body.setAttribute("data-user-authenticated","true"),document.body.setAttribute("data-user-type",t),this.populateUserData(o,n,t),this.showAuthenticatedContent(),this.applyRoleBasedVisibility(t),e.dispatchEvent(new CustomEvent("nikoAuthReady",{detail:{user:o,userType:t,authenticated:!0}})),console.log("User interface updated for:",n)}handleSignedOutUser(){document.body.removeAttribute("data-user-authenticated"),document.body.removeAttribute("data-user-type"),document.querySelectorAll('[niko-data="auth-required"]').forEach(e=>{e.style.visibility="hidden",e.style.opacity="0"}),e.dispatchEvent(new CustomEvent("nikoAuthSignedOut",{detail:{authenticated:!1}})),this.isProtectedPage()&&this.redirectToLogin()}populateUserData(e,o,t){document.querySelectorAll('[niko-data="user-name"]').forEach(e=>{e.textContent=o}),document.querySelectorAll('[niko-data="user-email"]').forEach(o=>{o.textContent=e.email}),document.querySelectorAll('[niko-data="user-role"]').forEach(e=>{e.textContent=t});const n={name:['[data-user="name"]',".user-name","#user-name"],email:['[data-user="email"]',".user-email","#user-email"],role:['[data-user="role"]',".user-role","#user-role"]};n.name.forEach(e=>{document.querySelectorAll(e).forEach(e=>e.textContent=o)}),n.email.forEach(o=>{document.querySelectorAll(o).forEach(o=>o.textContent=e.email)}),n.role.forEach(e=>{document.querySelectorAll(e).forEach(e=>e.textContent=t)})}showAuthenticatedContent(){document.querySelectorAll('[niko-data="auth-required"]').forEach(e=>{e.style.visibility="visible",e.style.opacity="1"}),document.body&&document.body.hasAttribute("niko-data")&&"auth-required"===document.body.getAttribute("niko-data")&&(document.body.style.visibility="visible",document.body.style.opacity="1")}applyRoleBasedVisibility(e){document.querySelectorAll("[niko-role]").forEach(o=>{o.getAttribute("niko-role").split(",").map(e=>e.trim()).includes(e)||o.remove()})}async register(o,t,i,a){if(console.log("📝 REGISTER METHOD CALLED"),console.log("👤 Registering user:",{email:o,userType:a,name:i}),console.log("🔧 Initialized status:",this.initialized),!this.initialized)throw console.error("❌ Authentication system not initialized"),new Error("Authentication system not initialized");try{const s="retailer"===a.toLowerCase()?e.location.origin+n.ROUTES.RETAILER_ONBOARDING:e.location.origin+n.ROUTES.CUSTOMER_ONBOARDING;console.log("🔄 Redirect URL:",s),console.log("📧 Calling Supabase auth.signUp...");const{data:r,error:l}=await this.supabase.auth.signUp({email:o,password:t,options:{data:{name:i,user_type:a.toLowerCase(),role:a.toLowerCase()},emailRedirectTo:s}});return l?(console.error("❌ Registration error:",l),{success:!1,error:l.message}):(console.log("✅ Registration successful:",r.user?.email),console.log("👤 User data:",r.user),console.log("📊 Creating Webflow record..."),await this.createWebflowRecord(r.user.id,o,i,a),console.log("🎉 Registration complete!"),{success:!0,user:r.user})}catch(e){return console.error("💥 Registration failed with error:",e),{success:!1,error:e.message}}}async login(o,t){if(console.log("Logging in user:",{email:o}),!this.initialized)throw new Error("Authentication system not initialized");try{const{data:i,error:a}=await this.supabase.auth.signInWithPassword({email:o,password:t});if(a)return console.error("Login error:",a),{success:!1,error:a.message};if(console.log("Login successful:",i.user?.email),i.session&&i.user){const o="retailer"===(i.user.user_metadata?.user_type||i.user.user_metadata?.role||"customer")?n.ROUTES.RETAILER_DASHBOARD:n.ROUTES.CUSTOMER_DASHBOARD;setTimeout(()=>{e.location.href=e.location.origin+o},100)}return{success:!0,user:i.user}}catch(e){return console.error("Login failed:",e),{success:!1,error:e.message}}}async logout(){if(console.log("Logging out user..."),!this.initialized)throw new Error("Authentication system not initialized");try{const{error:e}=await this.supabase.auth.signOut();return e?(console.error("Logout error:",e),{success:!1,error:e.message}):(localStorage.clear(),sessionStorage.clear(),console.log("Logout successful"),{success:!0})}catch(e){return console.error("Logout failed:",e),{success:!1,error:e.message}}}async getCurrentUser(){if(!this.initialized)return null;try{const{data:{user:e},error:o}=await this.supabase.auth.getUser();if(o)throw o;return e}catch(e){return console.error("Get user failed:",e),null}}async isAuthenticated(){return!!await this.getCurrentUser()}async checkAuthState(){const e=await this.getCurrentUser();e?(console.log("User authenticated:",e.email),this.handleAuthenticatedUser(e)):this.isProtectedPage()&&(console.log("No user found on protected page, redirecting..."),this.redirectToLogin())}async createWebflowRecord(e,o,t,n){try{const{data:i,error:a}=await this.supabase.functions.invoke("create-webflow-user",{body:{user_id:e,email:o,name:t,user_type:n}});a?console.warn("Webflow integration error (user still created in Supabase):",a):console.log("Webflow CMS record created")}catch(e){console.warn("Edge function error:",e)}}setupLogoutHandlers(){if("undefined"==typeof document)return;const o=[];['[niko-data="logout"]',"[data-logout]",".logout-btn",".logout-button",'a[href*="logout"]','button[onclick*="logout"]'].forEach(e=>{document.querySelectorAll(e).forEach(e=>{o.includes(e)||o.push(e)})}),console.log(`Found ${o.length} logout elements`),o.forEach(o=>{const t=o.cloneNode(!0);o.parentNode.replaceChild(t,o),t.addEventListener("click",async o=>{o.preventDefault(),o.stopPropagation(),console.log("Logout button clicked");const i=t.textContent;try{t.textContent="Logging out...",t.disabled=!0;const o=await this.logout();console.log("Logout result:",o),e.location.href=n.ROUTES.LOGIN_PAGE}catch(o){console.error("Logout error:",o),t.textContent=i,t.disabled=!1,e.location.href=n.ROUTES.LOGIN_PAGE}})}),console.log(`Setup ${o.length} logout handlers`)}isProtectedPage(){return void 0!==e&&(null!==document.querySelector('[niko-data="auth-required"]')||null!==document.querySelector('[data-auth="required"]')||e.location.pathname.includes("/dashboard")||e.location.pathname.includes(`${t}/app/customer/`)||e.location.pathname.includes(`${t}/app/retailer/`))}redirectToLogin(){const o=e.location.origin+n.ROUTES.LOGIN_PAGE;console.log("Redirecting to login:",o),e.location.href=o}isInitialized(){return this.initialized}getRedirectUrl(e){return"retailer"===e.toLowerCase()?n.ROUTES.RETAILER_DASHBOARD:n.ROUTES.CUSTOMER_DASHBOARD}}console.log("🏁 AUTO-INITIALIZE SECTION REACHED"),console.log("📄 Document readyState:",document.readyState),console.log("🌐 Window location:",e.location.href),"loading"===document.readyState?(console.log("⏳ Document still loading, waiting for DOMContentLoaded..."),document.addEventListener("DOMContentLoaded",()=>{console.log("🎬 DOMContentLoaded fired, creating NikoAuthCore..."),e.NikoAuthCore=new a,e.NikoAuth=e.NikoAuthCore,console.log("✅ window.NikoAuthCore created"),console.log("✅ window.NikoAuth alias created")})):(console.log("✨ Document ready, creating NikoAuthCore immediately..."),e.NikoAuthCore=new a,e.NikoAuth=e.NikoAuthCore,console.log("✅ window.NikoAuthCore created"),console.log("✅ window.NikoAuth alias created")),e.nikologout=async function(){console.log("🚪 nikologout function called"),e.NikoAuthCore?(await e.NikoAuthCore.logout(),e.location.href=n.ROUTES.LOGIN_PAGE):console.error("❌ window.NikoAuthCore not found")},console.log("✅ nikologout function registered"),console.log("🎉 NikoAuth: Professional authentication system loaded v5.0.0"),console.log("🔍 You can test with: window.NikoAuthCore or window.NikoAuth")}(window),console.log("Full bundle v5.0.0 loaded")})();