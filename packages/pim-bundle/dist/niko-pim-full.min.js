(()=>{"use strict";!function(e){const t="/dev/app/customer/onboarding",o="/dev/app/retailer/onboarding",s="/dev/app/customer/dashboard",a="/dev/app/retailer/dashboard",i="/dev/app/auth/log-in",n={getItem:e=>{const t=`; ${document.cookie}`.split(`; ${e}=`);return 2===t.length?decodeURIComponent(t.pop().split(";").shift()):null},setItem:(e,t)=>{document.cookie=`${e}=${encodeURIComponent(t)}; max-age=604800; path=/; secure; samesite=lax`},removeItem:e=>{document.cookie=`${e}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; secure; samesite=lax`}};class r{constructor(){console.log("🚀 NikoAuthCore constructor called"),this.supabase=null,this.initialized=!1,this.authStateListeners=[],console.log("📋 Initial state set, calling init()"),this.init()}async init(){console.log("🔧 Loading Niko Auth Core v5.0.0 (Professional)"),console.log("📍 Current URL:",e.location.href),console.log("🍪 Document cookies available:",document.cookie?"YES":"NO"),"undefined"==typeof supabase?(console.log("📦 Supabase not found, loading from CDN..."),await this.loadSupabase(),console.log("✅ Supabase loaded successfully")):console.log("✅ Supabase already available"),console.log("⚙️ Initializing Supabase client with professional config..."),this.supabase=supabase.createClient("https://bzjoxjqfpmjhbfijthpp.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6am94anFmcG1qaGJmaWp0aHBwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3NjIyMzksImV4cCI6MjA3MTMzODIzOX0.sL9omeLIgpgqYjTJM6SGQPSvUvm5z-Yr9rOzkOi2mJk",{auth:{storage:n,autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"pkce"}}),console.log("✅ Supabase client created with config:",{storage:"cookieStorage",autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"pkce"}),this.initialized=!0,console.log("🎉 Niko Auth Core v5.0.0 initialized with professional security"),console.log("🔗 Available on window.NikoAuthCore and window.NikoAuth"),console.log("👂 Setting up auth state listener..."),this.setupAuthStateListener(),console.log("🚪 Setting up logout handlers..."),this.setupLogoutHandlers(),console.log("🔍 Checking initial auth state..."),await this.checkAuthState(),console.log("✨ Initialization complete!")}loadSupabase(){return new Promise((e,t)=>{const o=document.createElement("script");o.src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2",o.onload=e,o.onerror=t,document.head.appendChild(o)})}setupAuthStateListener(){this.supabase.auth.onAuthStateChange((e,t)=>{switch(console.log("Auth state change:",e),e){case"SIGNED_IN":console.log("User signed in:",t?.user?.email),this.handleAuthenticatedUser(t.user);break;case"SIGNED_OUT":console.log("User signed out"),this.handleSignedOutUser();break;case"TOKEN_REFRESHED":console.log("Token refreshed automatically");break;case"USER_UPDATED":console.log("User updated")}this.authStateListeners.forEach(o=>{try{o(e,t)}catch(e){console.error("Auth state listener error:",e)}})})}onAuthStateChange(e){return this.authStateListeners.push(e),()=>{const t=this.authStateListeners.indexOf(e);t>-1&&this.authStateListeners.splice(t,1)}}handleAuthenticatedUser(t){if(!t)return;const o=t.user_metadata?.user_type||t.user_metadata?.role||"customer",s=t.user_metadata?.name||t.email?.split("@")[0]||"User";document.body.setAttribute("data-user-authenticated","true"),document.body.setAttribute("data-user-type",o),this.populateUserData(t,s,o),this.showAuthenticatedContent(),this.applyRoleBasedVisibility(o),e.dispatchEvent(new CustomEvent("nikoAuthReady",{detail:{user:t,userType:o,authenticated:!0}})),console.log("User interface updated for:",s)}handleSignedOutUser(){document.body.removeAttribute("data-user-authenticated"),document.body.removeAttribute("data-user-type"),document.querySelectorAll('[niko-data="auth-required"]').forEach(e=>{e.style.visibility="hidden",e.style.opacity="0"}),e.dispatchEvent(new CustomEvent("nikoAuthSignedOut",{detail:{authenticated:!1}})),this.isProtectedPage()&&this.redirectToLogin()}populateUserData(e,t,o){document.querySelectorAll('[niko-data="user-name"]').forEach(e=>{e.textContent=t}),document.querySelectorAll('[niko-data="user-email"]').forEach(t=>{t.textContent=e.email}),document.querySelectorAll('[niko-data="user-role"]').forEach(e=>{e.textContent=o});const s={name:['[data-user="name"]',".user-name","#user-name"],email:['[data-user="email"]',".user-email","#user-email"],role:['[data-user="role"]',".user-role","#user-role"]};s.name.forEach(e=>{document.querySelectorAll(e).forEach(e=>e.textContent=t)}),s.email.forEach(t=>{document.querySelectorAll(t).forEach(t=>t.textContent=e.email)}),s.role.forEach(e=>{document.querySelectorAll(e).forEach(e=>e.textContent=o)})}showAuthenticatedContent(){document.querySelectorAll('[niko-data="auth-required"]').forEach(e=>{e.style.visibility="visible",e.style.opacity="1"}),document.body&&document.body.hasAttribute("niko-data")&&"auth-required"===document.body.getAttribute("niko-data")&&(document.body.style.visibility="visible",document.body.style.opacity="1")}applyRoleBasedVisibility(e){document.querySelectorAll("[niko-role]").forEach(t=>{t.getAttribute("niko-role").split(",").map(e=>e.trim()).includes(e)||t.remove()})}async register(s,a,i,n){if(console.log("📝 REGISTER METHOD CALLED"),console.log("👤 Registering user:",{email:s,userType:n,name:i}),console.log("🔧 Initialized status:",this.initialized),!this.initialized)throw console.error("❌ Authentication system not initialized"),new Error("Authentication system not initialized");try{const r="retailer"===n.toLowerCase()?e.location.origin+o:e.location.origin+t;console.log("🔄 Redirect URL:",r),console.log("📧 Calling Supabase auth.signUp...");const{data:l,error:c}=await this.supabase.auth.signUp({email:s,password:a,options:{data:{name:i,user_type:n.toLowerCase(),role:n.toLowerCase()},emailRedirectTo:r}});return c?(console.error("❌ Registration error:",c),{success:!1,error:c.message}):(console.log("✅ Registration successful:",l.user?.email),console.log("👤 User data:",l.user),console.log("📊 Creating Webflow record..."),await this.createWebflowRecord(l.user.id,s,i,n),console.log("🎉 Registration complete!"),{success:!0,user:l.user})}catch(e){return console.error("💥 Registration failed with error:",e),{success:!1,error:e.message}}}async login(t,o){if(console.log("Logging in user:",{email:t}),!this.initialized)throw new Error("Authentication system not initialized");try{const{data:i,error:n}=await this.supabase.auth.signInWithPassword({email:t,password:o});if(n)return console.error("Login error:",n),{success:!1,error:n.message};if(console.log("Login successful:",i.user?.email),i.session&&i.user){const t="retailer"===(i.user.user_metadata?.user_type||i.user.user_metadata?.role||"customer")?a:s;setTimeout(()=>{e.location.href=e.location.origin+t},100)}return{success:!0,user:i.user}}catch(e){return console.error("Login failed:",e),{success:!1,error:e.message}}}async logout(){if(console.log("Logging out user..."),!this.initialized)throw new Error("Authentication system not initialized");try{const{error:e}=await this.supabase.auth.signOut();return e?(console.error("Logout error:",e),{success:!1,error:e.message}):(localStorage.clear(),sessionStorage.clear(),console.log("Logout successful"),{success:!0})}catch(e){return console.error("Logout failed:",e),{success:!1,error:e.message}}}async getCurrentUser(){if(!this.initialized)return null;try{const{data:{user:e},error:t}=await this.supabase.auth.getUser();if(t)throw t;return e}catch(e){return console.error("Get user failed:",e),null}}async isAuthenticated(){return!!await this.getCurrentUser()}async checkAuthState(){const e=await this.getCurrentUser();e?(console.log("User authenticated:",e.email),this.handleAuthenticatedUser(e)):this.isProtectedPage()&&(console.log("No user found on protected page, redirecting..."),this.redirectToLogin())}async createWebflowRecord(e,t,o,s){try{const{data:a,error:i}=await this.supabase.functions.invoke("create-webflow-user",{body:{user_id:e,email:t,name:o,user_type:s}});i?console.warn("Webflow integration error (user still created in Supabase):",i):console.log("Webflow CMS record created")}catch(e){console.warn("Edge function error:",e)}}setupLogoutHandlers(){if("undefined"==typeof document)return;const t=[];['[niko-data="logout"]',"[data-logout]",".logout-btn",".logout-button",'a[href*="logout"]','button[onclick*="logout"]'].forEach(e=>{document.querySelectorAll(e).forEach(e=>{t.includes(e)||t.push(e)})}),console.log(`Found ${t.length} logout elements`),t.forEach(t=>{const o=t.cloneNode(!0);t.parentNode.replaceChild(o,t),o.addEventListener("click",async t=>{t.preventDefault(),t.stopPropagation(),console.log("Logout button clicked");const s=o.textContent;try{o.textContent="Logging out...",o.disabled=!0;const t=await this.logout();console.log("Logout result:",t),e.location.href=i}catch(t){console.error("Logout error:",t),o.textContent=s,o.disabled=!1,e.location.href=i}})}),console.log(`Setup ${t.length} logout handlers`)}isProtectedPage(){return void 0!==e&&(null!==document.querySelector('[niko-data="auth-required"]')||null!==document.querySelector('[data-auth="required"]')||e.location.pathname.includes("/dashboard")||e.location.pathname.includes("/dev/app/customer/")||e.location.pathname.includes("/dev/app/retailer/"))}redirectToLogin(){const t=e.location.origin+i;console.log("Redirecting to login:",t),e.location.href=t}isInitialized(){return this.initialized}getRedirectUrl(e){return"retailer"===e.toLowerCase()?a:s}}console.log("🏁 AUTO-INITIALIZE SECTION REACHED"),console.log("📄 Document readyState:",document.readyState),console.log("🌐 Window location:",e.location.href),"loading"===document.readyState?(console.log("⏳ Document still loading, waiting for DOMContentLoaded..."),document.addEventListener("DOMContentLoaded",()=>{console.log("🎬 DOMContentLoaded fired, creating NikoAuthCore..."),e.NikoAuthCore=new r,e.NikoAuth=e.NikoAuthCore,console.log("✅ window.NikoAuthCore created"),console.log("✅ window.NikoAuth alias created")})):(console.log("✨ Document ready, creating NikoAuthCore immediately..."),e.NikoAuthCore=new r,e.NikoAuth=e.NikoAuthCore,console.log("✅ window.NikoAuthCore created"),console.log("✅ window.NikoAuth alias created")),e.nikologout=async function(){console.log("🚪 nikologout function called"),e.NikoAuthCore?(await e.NikoAuthCore.logout(),e.location.href=i):console.error("❌ window.NikoAuthCore not found")},console.log("✅ nikologout function registered"),console.log("🎉 NikoAuth: Professional authentication system loaded v5.0.0"),console.log("🔍 You can test with: window.NikoAuthCore or window.NikoAuth")}(window),console.log("Full bundle v5.0.0 loaded")})();