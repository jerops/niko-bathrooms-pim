(()=>{"use strict";!function(e){const t="/dev/app/customer/dashboard",o="/dev/app/retailer/dashboard",r="/dev/app/auth/log-in";e.NikoAuthCore=new class{constructor(){this.supabase=null,this.initialized=!1,this.init()}async init(){console.log("Loading Niko Auth Core v3.0.0 (Modular)"),"undefined"==typeof supabase&&await this.loadSupabase(),this.supabase=supabase.createClient("https://bzjoxjqfpmjhbfijthpp.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6am94anFmcG1qaGJmaWp0aHBwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3NjIyMzksImV4cCI6MjA3MTMzODIzOX0.sL9omeLIgpgqYjTJM6SGQPSvUvm5z-Yr9rOzkOi2mJk"),this.initialized=!0,console.log("Niko Auth Core initialized successfully"),this.setupLogoutHandlers(),this.checkAuthState()}isInitialized(){return this.initialized}loadSupabase(){return new Promise((e,t)=>{const o=document.createElement("script");o.src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2",o.onload=e,o.onerror=t,document.head.appendChild(o)})}async register(e,t,o,r){if(console.log("Registering user:",{email:e,userType:r}),!this.initialized)throw new Error("Authentication system not initialized");try{const s=document.querySelector("base")?.href||location.origin+"/",a="retailer"===r.toLowerCase()?s+"dev/app/retailer/onboarding":s+"dev/app/customer/onboarding",{data:i,error:n}=await this.supabase.auth.signUp({email:e,password:t,options:{data:{name:o,user_type:r.toLowerCase(),role:r.toLowerCase()},emailRedirectTo:a}});return n?(console.error("Registration error:",n),{success:!1,error:n.message}):(console.log("Registration successful:",i.user?.email),await this.createWebflowRecord(i.user.id,e,o,r),{success:!0,user:i.user})}catch(e){return console.error("Registration failed:",e),{success:!1,error:e.message}}}async login(e,t){if(console.log("Logging in user:",{email:e}),!this.initialized)throw new Error("Authentication system not initialized");try{const{data:o,error:r}=await this.supabase.auth.signInWithPassword({email:e,password:t});return r?(console.error("Login error:",r),{success:!1,error:r.message}):(console.log("Login successful:",o.user?.email),{success:!0,user:o.user})}catch(e){return console.error("Login failed:",e),{success:!1,error:e.message}}}async logout(){if(console.log("Logging out user..."),!this.initialized)throw new Error("Authentication system not initialized");try{const{error:e}=await this.supabase.auth.signOut();return localStorage.clear(),sessionStorage.clear(),e?(console.error("Logout error:",e),{success:!1,error:e.message}):(console.log("Logout successful"),{success:!0})}catch(e){return console.error("Logout failed:",e),{success:!1,error:e.message}}}async getCurrentUser(){if(!this.initialized)return null;try{const{data:{user:e},error:t}=await this.supabase.auth.getUser();if(t)throw t;return e}catch(e){return console.error("Get user failed:",e),null}}async isAuthenticated(){return!!await this.getCurrentUser()}async createWebflowRecord(e,t,o,r){try{const{data:s,error:a}=await this.supabase.functions.invoke("create-webflow-user",{body:{user_id:e,email:t,name:o,user_type:r}});a?console.warn("Webflow integration error (user still created in Supabase):",a):console.log("Webflow CMS record created")}catch(e){console.warn("Edge function error:",e)}}getRedirectUrl(e){return"retailer"===e.toLowerCase()?o:t}setupLogoutHandlers(){if("undefined"==typeof document)return;const t=[];['[niko-data="logout"]',"[data-logout]",".logout-btn",".logout-button",'a[href*="logout"]','button[onclick*="logout"]'].forEach(e=>{document.querySelectorAll(e).forEach(e=>{t.includes(e)||t.push(e)})}),console.log(`Found ${t.length} logout elements`),t.forEach(t=>{const o=t.cloneNode(!0);t.parentNode.replaceChild(o,t),o.addEventListener("click",async t=>{t.preventDefault(),t.stopPropagation(),console.log("Logout button clicked");const s=o.textContent;try{o.textContent="Logging out...",o.disabled=!0;const t=await this.logout();console.log("Logout result:",t),e.location.href=r}catch(t){console.error("Logout error:",t),o.textContent=s,o.disabled=!1,e.location.href=r}})}),console.log(`Setup ${t.length} logout handlers`)}async checkAuthState(){if("undefined"!=typeof document)try{const t=await this.getCurrentUser();t?(this.displayUserInfo(t),console.log("User authenticated:",t.email)):this.isProtectedPage()&&(console.log("No user found on protected page, redirecting..."),e.location.href=r)}catch(e){console.error("Auth state check failed:",e)}}displayUserInfo(e){if("undefined"==typeof document)return;const t=e.user_metadata?.name||e.email.split("@")[0],o=e.user_metadata?.user_type||"customer",r={name:['[data-user="name"]','[niko-data="user-name"]',".user-name","#user-name"],email:['[data-user="email"]','[niko-data="user-email"]',".user-email","#user-email"],role:['[data-user="role"]','[niko-data="user-role"]',".user-role","#user-role"]};r.name.forEach(e=>{document.querySelectorAll(e).forEach(e=>e.textContent=t)}),r.email.forEach(t=>{document.querySelectorAll(t).forEach(t=>t.textContent=e.email)}),r.role.forEach(e=>{document.querySelectorAll(e).forEach(e=>e.textContent=o)}),console.log("User info displayed")}isProtectedPage(){return void 0!==e&&["/dev/app/customer/","/dev/app/retailer/","/dashboard","/profile"].some(t=>e.location.pathname.includes(t))}},e.NikoAuth=e.NikoAuthCore,e.nikologout=async function(){e.NikoAuthCore&&(await e.NikoAuthCore.logout(),e.location.href=r)}}(window),function(e){const t="/dev/app/customer/onboarding",o="/dev/app/retailer/onboarding",r="/dev/app/customer/dashboard",s="/dev/app/retailer/dashboard",a="/dev/app/auth/log-in",i={getItem:e=>{const t=`; ${document.cookie}`.split(`; ${e}=`);return 2===t.length?decodeURIComponent(t.pop().split(";").shift()):null},setItem:(e,t)=>{document.cookie=`${e}=${encodeURIComponent(t)}; max-age=604800; path=/; secure; samesite=lax`},removeItem:e=>{document.cookie=`${e}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; secure; samesite=lax`}};class n{constructor(){this.supabase=null,this.initialized=!1,this.authStateListeners=[],this.init()}async init(){console.log("Loading Niko Auth Core v5.0.0 (Professional)"),"undefined"==typeof supabase&&await this.loadSupabase(),this.supabase=supabase.createClient("https://bzjoxjqfpmjhbfijthpp.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6am94anFmcG1qaGJmaWp0aHBwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3NjIyMzksImV4cCI6MjA3MTMzODIzOX0.sL9omeLIgpgqYjTJM6SGQPSvUvm5z-Yr9rOzkOi2mJk",{auth:{storage:i,autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"pkce"}}),this.initialized=!0,console.log("Niko Auth Core v5.0.0 initialized with professional security"),this.setupAuthStateListener(),this.setupLogoutHandlers(),await this.checkAuthState()}loadSupabase(){return new Promise((e,t)=>{const o=document.createElement("script");o.src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2",o.onload=e,o.onerror=t,document.head.appendChild(o)})}setupAuthStateListener(){this.supabase.auth.onAuthStateChange((e,t)=>{switch(console.log("Auth state change:",e),e){case"SIGNED_IN":console.log("User signed in:",t?.user?.email),this.handleAuthenticatedUser(t.user);break;case"SIGNED_OUT":console.log("User signed out"),this.handleSignedOutUser();break;case"TOKEN_REFRESHED":console.log("Token refreshed automatically");break;case"USER_UPDATED":console.log("User updated")}this.authStateListeners.forEach(o=>{try{o(e,t)}catch(e){console.error("Auth state listener error:",e)}})})}onAuthStateChange(e){return this.authStateListeners.push(e),()=>{const t=this.authStateListeners.indexOf(e);t>-1&&this.authStateListeners.splice(t,1)}}handleAuthenticatedUser(t){if(!t)return;const o=t.user_metadata?.user_type||t.user_metadata?.role||"customer",r=t.user_metadata?.name||t.email?.split("@")[0]||"User";document.body.setAttribute("data-user-authenticated","true"),document.body.setAttribute("data-user-type",o),this.populateUserData(t,r,o),this.showAuthenticatedContent(),this.applyRoleBasedVisibility(o),e.dispatchEvent(new CustomEvent("nikoAuthReady",{detail:{user:t,userType:o,authenticated:!0}})),console.log("User interface updated for:",r)}handleSignedOutUser(){document.body.removeAttribute("data-user-authenticated"),document.body.removeAttribute("data-user-type"),document.querySelectorAll('[niko-data="auth-required"]').forEach(e=>{e.style.visibility="hidden",e.style.opacity="0"}),e.dispatchEvent(new CustomEvent("nikoAuthSignedOut",{detail:{authenticated:!1}})),this.isProtectedPage()&&this.redirectToLogin()}populateUserData(e,t,o){document.querySelectorAll('[niko-data="user-name"]').forEach(e=>{e.textContent=t}),document.querySelectorAll('[niko-data="user-email"]').forEach(t=>{t.textContent=e.email}),document.querySelectorAll('[niko-data="user-role"]').forEach(e=>{e.textContent=o});const r={name:['[data-user="name"]',".user-name","#user-name"],email:['[data-user="email"]',".user-email","#user-email"],role:['[data-user="role"]',".user-role","#user-role"]};r.name.forEach(e=>{document.querySelectorAll(e).forEach(e=>e.textContent=t)}),r.email.forEach(t=>{document.querySelectorAll(t).forEach(t=>t.textContent=e.email)}),r.role.forEach(e=>{document.querySelectorAll(e).forEach(e=>e.textContent=o)})}showAuthenticatedContent(){document.querySelectorAll('[niko-data="auth-required"]').forEach(e=>{e.style.visibility="visible",e.style.opacity="1"}),document.body&&document.body.hasAttribute("niko-data")&&"auth-required"===document.body.getAttribute("niko-data")&&(document.body.style.visibility="visible",document.body.style.opacity="1")}applyRoleBasedVisibility(e){document.querySelectorAll("[niko-role]").forEach(t=>{t.getAttribute("niko-role").split(",").map(e=>e.trim()).includes(e)||t.remove()})}async register(r,s,a,i){if(console.log("Registering user:",{email:r,userType:i}),!this.initialized)throw new Error("Authentication system not initialized");try{const n="retailer"===i.toLowerCase()?e.location.origin+o:e.location.origin+t,{data:u,error:c}=await this.supabase.auth.signUp({email:r,password:s,options:{data:{name:a,user_type:i.toLowerCase(),role:i.toLowerCase()},emailRedirectTo:n}});return c?(console.error("Registration error:",c),{success:!1,error:c.message}):(console.log("Registration successful:",u.user?.email),await this.createWebflowRecord(u.user.id,r,a,i),{success:!0,user:u.user})}catch(e){return console.error("Registration failed:",e),{success:!1,error:e.message}}}async login(t,o){if(console.log("Logging in user:",{email:t}),!this.initialized)throw new Error("Authentication system not initialized");try{const{data:a,error:i}=await this.supabase.auth.signInWithPassword({email:t,password:o});if(i)return console.error("Login error:",i),{success:!1,error:i.message};if(console.log("Login successful:",a.user?.email),a.session&&a.user){const t="retailer"===(a.user.user_metadata?.user_type||a.user.user_metadata?.role||"customer")?s:r;setTimeout(()=>{e.location.href=e.location.origin+t},100)}return{success:!0,user:a.user}}catch(e){return console.error("Login failed:",e),{success:!1,error:e.message}}}async logout(){if(console.log("Logging out user..."),!this.initialized)throw new Error("Authentication system not initialized");try{const{error:e}=await this.supabase.auth.signOut();return e?(console.error("Logout error:",e),{success:!1,error:e.message}):(localStorage.clear(),sessionStorage.clear(),console.log("Logout successful"),{success:!0})}catch(e){return console.error("Logout failed:",e),{success:!1,error:e.message}}}async getCurrentUser(){if(!this.initialized)return null;try{const{data:{user:e},error:t}=await this.supabase.auth.getUser();if(t)throw t;return e}catch(e){return console.error("Get user failed:",e),null}}async isAuthenticated(){return!!await this.getCurrentUser()}async checkAuthState(){const e=await this.getCurrentUser();e?(console.log("User authenticated:",e.email),this.handleAuthenticatedUser(e)):this.isProtectedPage()&&(console.log("No user found on protected page, redirecting..."),this.redirectToLogin())}async createWebflowRecord(e,t,o,r){try{const{data:s,error:a}=await this.supabase.functions.invoke("create-webflow-user",{body:{user_id:e,email:t,name:o,user_type:r}});a?console.warn("Webflow integration error (user still created in Supabase):",a):console.log("Webflow CMS record created")}catch(e){console.warn("Edge function error:",e)}}setupLogoutHandlers(){if("undefined"==typeof document)return;const t=[];['[niko-data="logout"]',"[data-logout]",".logout-btn",".logout-button",'a[href*="logout"]','button[onclick*="logout"]'].forEach(e=>{document.querySelectorAll(e).forEach(e=>{t.includes(e)||t.push(e)})}),console.log(`Found ${t.length} logout elements`),t.forEach(t=>{const o=t.cloneNode(!0);t.parentNode.replaceChild(o,t),o.addEventListener("click",async t=>{t.preventDefault(),t.stopPropagation(),console.log("Logout button clicked");const r=o.textContent;try{o.textContent="Logging out...",o.disabled=!0;const t=await this.logout();console.log("Logout result:",t),e.location.href=a}catch(t){console.error("Logout error:",t),o.textContent=r,o.disabled=!1,e.location.href=a}})}),console.log(`Setup ${t.length} logout handlers`)}isProtectedPage(){return void 0!==e&&(null!==document.querySelector('[niko-data="auth-required"]')||null!==document.querySelector('[data-auth="required"]')||e.location.pathname.includes("/dashboard")||e.location.pathname.includes("/dev/app/customer/")||e.location.pathname.includes("/dev/app/retailer/"))}redirectToLogin(){const t=e.location.origin+a;console.log("Redirecting to login:",t),e.location.href=t}isInitialized(){return this.initialized}getRedirectUrl(e){return"retailer"===e.toLowerCase()?s:r}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{e.NikoAuthCore=new n,e.NikoAuth=e.NikoAuthCore}):(e.NikoAuthCore=new n,e.NikoAuth=e.NikoAuthCore),e.nikologout=async function(){e.NikoAuthCore&&(await e.NikoAuthCore.logout(),e.location.href=a)},console.log("NikoAuth: Professional authentication system loaded v5.0.0")}(window)})();