(()=>{"use strict";!function(e){const o="/dev/app/customer/dashboard",t="/dev/app/retailer/dashboard",r="/dev/app/auth/log-in";e.NikoAuthCore=new class{constructor(){this.supabase=null,this.initialized=!1,this.init()}async init(){console.log("Loading Niko Auth Core v3.0.0 (Modular)"),"undefined"==typeof supabase&&await this.loadSupabase(),this.supabase=supabase.createClient("https://bzjoxjqfpmjhbfijthpp.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6am94anFmcG1qaGJmaWp0aHBwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3NjIyMzksImV4cCI6MjA3MTMzODIzOX0.sL9omeLIgpgqYjTJM6SGQPSvUvm5z-Yr9rOzkOi2mJk"),this.initialized=!0,console.log("Niko Auth Core initialized successfully"),this.setupLogoutHandlers(),this.checkAuthState()}isInitialized(){return this.initialized}loadSupabase(){return new Promise((e,o)=>{const t=document.createElement("script");t.src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2",t.onload=e,t.onerror=o,document.head.appendChild(t)})}async register(e,o,t,r){if(console.log("Registering user:",{email:e,userType:r}),!this.initialized)throw new Error("Authentication system not initialized");try{const s=document.querySelector("base")?.href||location.origin+"/",a="retailer"===r.toLowerCase()?s+"dev/app/retailer/onboarding":s+"dev/app/customer/onboarding",{data:n,error:i}=await this.supabase.auth.signUp({email:e,password:o,options:{data:{name:t,user_type:r.toLowerCase(),role:r.toLowerCase()},emailRedirectTo:a}});return i?(console.error("Registration error:",i),{success:!1,error:i.message}):(console.log("Registration successful:",n.user?.email),await this.createWebflowRecord(n.user.id,e,t,r),{success:!0,user:n.user})}catch(e){return console.error("Registration failed:",e),{success:!1,error:e.message}}}async login(e,o){if(console.log("Logging in user:",{email:e}),!this.initialized)throw new Error("Authentication system not initialized");try{const{data:t,error:r}=await this.supabase.auth.signInWithPassword({email:e,password:o});return r?(console.error("Login error:",r),{success:!1,error:r.message}):(console.log("Login successful:",t.user?.email),{success:!0,user:t.user})}catch(e){return console.error("Login failed:",e),{success:!1,error:e.message}}}async logout(){if(console.log("Logging out user..."),!this.initialized)throw new Error("Authentication system not initialized");try{const{error:e}=await this.supabase.auth.signOut();return localStorage.clear(),sessionStorage.clear(),e?(console.error("Logout error:",e),{success:!1,error:e.message}):(console.log("Logout successful"),{success:!0})}catch(e){return console.error("Logout failed:",e),{success:!1,error:e.message}}}async getCurrentUser(){if(!this.initialized)return null;try{const{data:{user:e},error:o}=await this.supabase.auth.getUser();if(o)throw o;return e}catch(e){return console.error("Get user failed:",e),null}}async isAuthenticated(){return!!await this.getCurrentUser()}async createWebflowRecord(e,o,t,r){try{const{data:s,error:a}=await this.supabase.functions.invoke("create-webflow-user",{body:{user_id:e,email:o,name:t,user_type:r}});a?console.warn("Webflow integration error (user still created in Supabase):",a):console.log("Webflow CMS record created")}catch(e){console.warn("Edge function error:",e)}}getRedirectUrl(e){return"retailer"===e.toLowerCase()?t:o}setupLogoutHandlers(){if("undefined"==typeof document)return;const o=[];['[niko-data="logout"]',"[data-logout]",".logout-btn",".logout-button",'a[href*="logout"]','button[onclick*="logout"]'].forEach(e=>{document.querySelectorAll(e).forEach(e=>{o.includes(e)||o.push(e)})}),console.log(`Found ${o.length} logout elements`),o.forEach(o=>{const t=o.cloneNode(!0);o.parentNode.replaceChild(t,o),t.addEventListener("click",async o=>{o.preventDefault(),o.stopPropagation(),console.log("Logout button clicked");const s=t.textContent;try{t.textContent="Logging out...",t.disabled=!0;const o=await this.logout();console.log("Logout result:",o),e.location.href=r}catch(o){console.error("Logout error:",o),t.textContent=s,t.disabled=!1,e.location.href=r}})}),console.log(`Setup ${o.length} logout handlers`)}async checkAuthState(){if("undefined"!=typeof document)try{const o=await this.getCurrentUser();o?(this.displayUserInfo(o),console.log("User authenticated:",o.email)):this.isProtectedPage()&&(console.log("No user found on protected page, redirecting..."),e.location.href=r)}catch(e){console.error("Auth state check failed:",e)}}displayUserInfo(e){if("undefined"==typeof document)return;const o=e.user_metadata?.name||e.email.split("@")[0],t=e.user_metadata?.user_type||"customer",r={name:['[data-user="name"]','[niko-data="user-name"]',".user-name","#user-name"],email:['[data-user="email"]','[niko-data="user-email"]',".user-email","#user-email"],role:['[data-user="role"]','[niko-data="user-role"]',".user-role","#user-role"]};r.name.forEach(e=>{document.querySelectorAll(e).forEach(e=>e.textContent=o)}),r.email.forEach(o=>{document.querySelectorAll(o).forEach(o=>o.textContent=e.email)}),r.role.forEach(e=>{document.querySelectorAll(e).forEach(e=>e.textContent=t)}),console.log("User info displayed")}isProtectedPage(){return void 0!==e&&["/dev/app/customer/","/dev/app/retailer/","/dashboard","/profile"].some(o=>e.location.pathname.includes(o))}},e.NikoAuth=e.NikoAuthCore,e.nikologout=async function(){e.NikoAuthCore&&(await e.NikoAuthCore.logout(),e.location.href=r)}}(window),function(e){const o="localhost"===e.location.hostname||"127.0.0.1"===e.location.hostname||e.location.hostname.includes("webflow.io"),t=o?"/dev":"",r={SUPABASE_URL:"https://bzjoxjqfpmjhbfijthpp.supabase.co",SUPABASE_ANON_KEY:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6am94anFmcG1qaGJmaWp0aHBwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3NjIyMzksImV4cCI6MjA3MTMzODIzOX0.sL9omeLIgpgqYjTJM6SGQPSvUvm5z-Yr9rOzkOi2mJk",ROUTES:{CUSTOMER_ONBOARDING:`${t}/app/customer/onboarding`,RETAILER_ONBOARDING:`${t}/app/retailer/onboarding`,CUSTOMER_DASHBOARD:`${t}/app/customer/dashboard`,RETAILER_DASHBOARD:`${t}/app/retailer/dashboard`,LOGIN_PAGE:`${t}/app/auth/log-in`}},s={getItem:e=>{const o=`; ${document.cookie}`.split(`; ${e}=`);return 2===o.length?decodeURIComponent(o.pop().split(";").shift()):null},setItem:(e,o)=>{document.cookie=`${e}=${encodeURIComponent(o)}; max-age=604800; path=/; secure; samesite=lax`},removeItem:e=>{document.cookie=`${e}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; secure; samesite=lax`}};class a{constructor(){console.log("ğŸš€ NikoAuthCore constructor called"),this.supabase=null,this.initialized=!1,this.authStateListeners=[],console.log("ğŸ“‹ Initial state set, calling init()"),this.init()}async init(){console.log("ğŸ”§ Loading Niko Auth Core v5.0.0 (Professional)"),console.log("ğŸŒ Environment:",o?"DEVELOPMENT":"PRODUCTION"),console.log("ğŸ“ Current URL:",e.location.href),console.log("ğŸ›¤ï¸ Path prefix:",t||"(none)"),console.log("ğŸª Document cookies available:",document.cookie?"YES":"NO"),"undefined"==typeof supabase?(console.log("ğŸ“¦ Supabase not found, loading from CDN..."),await this.loadSupabase(),console.log("âœ… Supabase loaded successfully")):console.log("âœ… Supabase already available"),console.log("âš™ï¸ Initializing Supabase client with professional config..."),this.supabase=supabase.createClient(r.SUPABASE_URL,r.SUPABASE_ANON_KEY,{auth:{storage:s,autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"pkce"}}),console.log("âœ… Supabase client created with config:",{storage:"cookieStorage",autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"pkce"}),this.initialized=!0,console.log("ğŸ‰ Niko Auth Core v5.0.0 initialized with professional security"),console.log("ğŸ”— Available on window.NikoAuthCore and window.NikoAuth"),console.log("ğŸ‘‚ Setting up auth state listener..."),this.setupAuthStateListener(),console.log("ğŸšª Setting up logout handlers..."),this.setupLogoutHandlers(),console.log("ğŸ“§ Checking for email confirmation token..."),await this.handleEmailConfirmation(),console.log("ğŸ” Checking initial auth state..."),await this.checkAuthState(),console.log("âœ¨ Initialization complete!")}loadSupabase(){return new Promise((e,o)=>{const t=document.createElement("script");t.src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2",t.onload=e,t.onerror=o,document.head.appendChild(t)})}async handleEmailConfirmation(){const o=new URLSearchParams(e.location.hash.substring(1)),t=o.get("access_token"),r=o.get("refresh_token");if(t&&r){console.log("ğŸ“¬ Email confirmation tokens found in URL");try{const{data:o,error:s}=await this.supabase.auth.setSession({access_token:t,refresh_token:r});if(s)return void console.error("âŒ Error setting session from email confirmation:",s);console.log("âœ… Session established from email confirmation"),console.log("ğŸ‘¤ User confirmed:",o.user?.email),e.history.replaceState({},document.title,e.location.pathname),this.handleAuthenticatedUser(o.user)}catch(e){console.error("âŒ Failed to handle email confirmation:",e)}}else console.log("ğŸ“­ No email confirmation tokens in URL")}setupAuthStateListener(){this.supabase.auth.onAuthStateChange((e,o)=>{switch(console.log("Auth state change:",e),e){case"SIGNED_IN":console.log("User signed in:",o?.user?.email),this.handleAuthenticatedUser(o.user);break;case"SIGNED_OUT":console.log("User signed out"),this.handleSignedOutUser();break;case"TOKEN_REFRESHED":console.log("Token refreshed automatically");break;case"USER_UPDATED":console.log("User updated")}this.authStateListeners.forEach(t=>{try{t(e,o)}catch(e){console.error("Auth state listener error:",e)}})})}onAuthStateChange(e){return this.authStateListeners.push(e),()=>{const o=this.authStateListeners.indexOf(e);o>-1&&this.authStateListeners.splice(o,1)}}handleAuthenticatedUser(o){if(!o)return;const t=o.user_metadata?.user_type||o.user_metadata?.role||"customer",r=o.user_metadata?.name||o.email?.split("@")[0]||"User";document.body.setAttribute("data-user-authenticated","true"),document.body.setAttribute("data-user-type",t),this.populateUserData(o,r,t),this.showAuthenticatedContent(),this.applyRoleBasedVisibility(t),e.dispatchEvent(new CustomEvent("nikoAuthReady",{detail:{user:o,userType:t,authenticated:!0}})),console.log("User interface updated for:",r)}handleSignedOutUser(){document.body.removeAttribute("data-user-authenticated"),document.body.removeAttribute("data-user-type"),document.querySelectorAll('[niko-data="auth-required"]').forEach(e=>{e.style.visibility="hidden",e.style.opacity="0"}),e.dispatchEvent(new CustomEvent("nikoAuthSignedOut",{detail:{authenticated:!1}})),this.isProtectedPage()&&this.redirectToLogin()}populateUserData(e,o,t){document.querySelectorAll('[niko-data="user-name"]').forEach(e=>{e.textContent=o}),document.querySelectorAll('[niko-data="user-email"]').forEach(o=>{o.textContent=e.email}),document.querySelectorAll('[niko-data="user-role"]').forEach(e=>{e.textContent=t});const r={name:['[data-user="name"]',".user-name","#user-name"],email:['[data-user="email"]',".user-email","#user-email"],role:['[data-user="role"]',".user-role","#user-role"]};r.name.forEach(e=>{document.querySelectorAll(e).forEach(e=>e.textContent=o)}),r.email.forEach(o=>{document.querySelectorAll(o).forEach(o=>o.textContent=e.email)}),r.role.forEach(e=>{document.querySelectorAll(e).forEach(e=>e.textContent=t)})}showAuthenticatedContent(){document.querySelectorAll('[niko-data="auth-required"]').forEach(e=>{e.style.visibility="visible",e.style.opacity="1"}),document.body&&document.body.hasAttribute("niko-data")&&"auth-required"===document.body.getAttribute("niko-data")&&(document.body.style.visibility="visible",document.body.style.opacity="1")}applyRoleBasedVisibility(e){document.querySelectorAll("[niko-role]").forEach(o=>{o.getAttribute("niko-role").split(",").map(e=>e.trim()).includes(e)||o.remove()})}async register(o,t,s,a){if(console.log("ğŸ“ REGISTER METHOD CALLED"),console.log("ğŸ‘¤ Registering user:",{email:o,userType:a,name:s}),console.log("ğŸ”§ Initialized status:",this.initialized),!this.initialized)throw console.error("âŒ Authentication system not initialized"),new Error("Authentication system not initialized");try{const n="retailer"===a.toLowerCase()?e.location.origin+r.ROUTES.RETAILER_ONBOARDING:e.location.origin+r.ROUTES.CUSTOMER_ONBOARDING;console.log("ğŸ”„ Redirect URL:",n),console.log("ğŸ“§ Calling Supabase auth.signUp...");const{data:i,error:l}=await this.supabase.auth.signUp({email:o,password:t,options:{data:{name:s,user_type:a.toLowerCase(),role:a.toLowerCase()},emailRedirectTo:n}});return l?(console.error("âŒ Registration error:",l),{success:!1,error:l.message}):(console.log("âœ… Registration successful:",i.user?.email),console.log("ğŸ‘¤ User data:",i.user),console.log("ğŸ“Š Creating Webflow record..."),await this.createWebflowRecord(i.user.id,o,s,a),console.log("ğŸ‰ Registration complete!"),{success:!0,user:i.user})}catch(e){return console.error("ğŸ’¥ Registration failed with error:",e),{success:!1,error:e.message}}}async login(o,t){if(console.log("Logging in user:",{email:o}),!this.initialized)throw new Error("Authentication system not initialized");try{const{data:s,error:a}=await this.supabase.auth.signInWithPassword({email:o,password:t});if(a)return console.error("Login error:",a),{success:!1,error:a.message};if(console.log("Login successful:",s.user?.email),s.session&&s.user){const o="retailer"===(s.user.user_metadata?.user_type||s.user.user_metadata?.role||"customer")?r.ROUTES.RETAILER_DASHBOARD:r.ROUTES.CUSTOMER_DASHBOARD;setTimeout(()=>{e.location.href=e.location.origin+o},100)}return{success:!0,user:s.user}}catch(e){return console.error("Login failed:",e),{success:!1,error:e.message}}}async logout(){if(console.log("Logging out user..."),!this.initialized)throw new Error("Authentication system not initialized");try{const{error:e}=await this.supabase.auth.signOut();return e?(console.error("Logout error:",e),{success:!1,error:e.message}):(localStorage.clear(),sessionStorage.clear(),console.log("Logout successful"),{success:!0})}catch(e){return console.error("Logout failed:",e),{success:!1,error:e.message}}}async getCurrentUser(){if(!this.initialized)return null;try{const{data:{user:e},error:o}=await this.supabase.auth.getUser();if(o)throw o;return e}catch(e){return console.error("Get user failed:",e),null}}async isAuthenticated(){return!!await this.getCurrentUser()}async checkAuthState(){const e=await this.getCurrentUser();e?(console.log("User authenticated:",e.email),this.handleAuthenticatedUser(e)):this.isProtectedPage()&&(console.log("No user found on protected page, redirecting..."),this.redirectToLogin())}async createWebflowRecord(e,o,t,r){try{const{data:s,error:a}=await this.supabase.functions.invoke("create-webflow-user",{body:{user_id:e,email:o,name:t,user_type:r}});a?console.warn("Webflow integration error (user still created in Supabase):",a):console.log("Webflow CMS record created")}catch(e){console.warn("Edge function error:",e)}}setupLogoutHandlers(){if("undefined"==typeof document)return;const o=[];['[niko-data="logout"]',"[data-logout]",".logout-btn",".logout-button",'a[href*="logout"]','button[onclick*="logout"]'].forEach(e=>{document.querySelectorAll(e).forEach(e=>{o.includes(e)||o.push(e)})}),console.log(`Found ${o.length} logout elements`),o.forEach(o=>{const t=o.cloneNode(!0);o.parentNode.replaceChild(t,o),t.addEventListener("click",async o=>{o.preventDefault(),o.stopPropagation(),console.log("Logout button clicked");const s=t.textContent;try{t.textContent="Logging out...",t.disabled=!0;const o=await this.logout();console.log("Logout result:",o),e.location.href=r.ROUTES.LOGIN_PAGE}catch(o){console.error("Logout error:",o),t.textContent=s,t.disabled=!1,e.location.href=r.ROUTES.LOGIN_PAGE}})}),console.log(`Setup ${o.length} logout handlers`)}isProtectedPage(){return void 0!==e&&(null!==document.querySelector('[niko-data="auth-required"]')||null!==document.querySelector('[data-auth="required"]')||e.location.pathname.includes("/dashboard")||e.location.pathname.includes(`${t}/app/customer/`)||e.location.pathname.includes(`${t}/app/retailer/`))}redirectToLogin(){const o=e.location.origin+r.ROUTES.LOGIN_PAGE;console.log("Redirecting to login:",o),e.location.href=o}isInitialized(){return this.initialized}getRedirectUrl(e){return"retailer"===e.toLowerCase()?r.ROUTES.RETAILER_DASHBOARD:r.ROUTES.CUSTOMER_DASHBOARD}}console.log("ğŸ AUTO-INITIALIZE SECTION REACHED"),console.log("ğŸ“„ Document readyState:",document.readyState),console.log("ğŸŒ Window location:",e.location.href),"loading"===document.readyState?(console.log("â³ Document still loading, waiting for DOMContentLoaded..."),document.addEventListener("DOMContentLoaded",()=>{console.log("ğŸ¬ DOMContentLoaded fired, creating NikoAuthCore..."),e.NikoAuthCore=new a,e.NikoAuth=e.NikoAuthCore,console.log("âœ… window.NikoAuthCore created"),console.log("âœ… window.NikoAuth alias created")})):(console.log("âœ¨ Document ready, creating NikoAuthCore immediately..."),e.NikoAuthCore=new a,e.NikoAuth=e.NikoAuthCore,console.log("âœ… window.NikoAuthCore created"),console.log("âœ… window.NikoAuth alias created")),e.nikologout=async function(){console.log("ğŸšª nikologout function called"),e.NikoAuthCore?(await e.NikoAuthCore.logout(),e.location.href=r.ROUTES.LOGIN_PAGE):console.error("âŒ window.NikoAuthCore not found")},console.log("âœ… nikologout function registered"),console.log("ğŸ‰ NikoAuth: Professional authentication system loaded v5.0.0"),console.log("ğŸ” You can test with: window.NikoAuthCore or window.NikoAuth")}(window)})();